<!DOCTYPE html>
<head>
<style>
.red-button{
	background-color: #ff0000
}
.blue-button{
	background-color: #0000ff
}
</style>

<title>Form for registration</title>
<meta charset="UTF-8"></meta>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src='js/config.js'></script>
</head>

<body>
	<h1>Registration form</h1>
	<p>Fill in reg data</p>

	<form onsubmit="return false">
		<label>e-mail</label><br>
		<input type="email" id="form_email"></input><br><br>
		<label>password</label><br>
		<input type="password" id="form_pass"></input><br><br>
		<button class="red-button" id="registration">Registration</button>
		<button class="blue-button" id="login">Login</button>
	</form>
	
	<form id="upload_file_form" enctype="multipart/form-data" method="post" onsubmit="return false">
		<input type="hidden" class="form_user_id" name="user_id" />
		<input type="file" id="form_file" name="filename"><br><br>
		<input type="submit" value="submit" />
    </form>
	
	<form id="file_form" enctype="multipart/form-data" method="post" onsubmit="return false">
		<input type="hidden" class="form_user_id" name="user_id" />
		<label>delete</label><br>
		<input type="radio" name="action" value="delete"><br><br>
		<label>download</label><br>
		<input type="radio" name="action" value="download"><br><br>
		<label>files:</label><br>
		<div id="radio_group" ></div>
		<input type="submit" value="submit" />
    </form>

	<details>
		<summary>See registration data</summary>
		<table>
			<tr>
			  <th>Name field</th>
			  <th>Value field</th>
			</tr>
			<tr>
			  <td>Email</td>
			  <td id="table_email">-</td>
			</tr>
			<tr>
			  <td>Password</td>
			  <td id="table_pass">-</td>
			</tr>
			<tr>
			  <td>ID</td>
			  <td id="table_id">-</td>
			</tr>
		</table>
	</details>

</body>

<script>
	$(document).ready(function(){
	    $('#upload_file_form').attr('action', app.endpoint+"/api/upload");
		$('#file_form').attr('action', app.endpoint+"/api/file/delete");
		
		$("#registration").click(function(){
			var email = $("#form_email").val();
			var pass = $("#form_pass").val();
			$.ajax(app.endpoint+"/api/registr", {
				type: "POST",
				data: { login: email, password: pass }
			}).done(function(data){
                        data = JSON.parse(data);
				if (data.status == 200){
					login_update(email, pass, data);
					alert("status: " + data.status + " user registered");
				} else {
					alert("status: " + data.status);
				}
			}).fail(function(jqXhr, statuscode, errorMSG){
				alert("error: " + errorMSG);
			});
		});
		
		$("#login").click(function(){
			var email = $("#form_email").val();
			var pass = $("#form_pass").val();
			$.ajax(app.endpoint+"/api/login", {
				type: "POST",
				data: { login: email, password: pass }
			}).done(function(data){
                        data = JSON.parse(data);
				if (data.status == 200){
					login_update(email, pass, data);
					alert("status: " + data.status + " login succeeded");
					list_files(data);
				} else {
					alert("status: " + data.status);
				}
			}).fail(function(jqXhr, statuscode, errorMSG){
				alert("error: " + errorMSG);
			});
		});
		
		function login_update(email, pass, data) {
			$("#table_email").text(email);
			$("#table_pass").text(pass);
			$("#table_id").text(data.ID);
			$(".form_user_id").val(data.ID);
		}
		function list_files(data) {
			$.ajax(app.endpoint+"/api/file/list", {
				type: "POST",
				data: { user_id: data.ID }
			}).done(function(data){
                        data = JSON.parse(data);
				if (data.status == 200){
					for(var i=0; i<data.files.length; i++){
						var file_name = data.files[i];
						$("#radio_group").append("<label>" + file_name + "</label><br><input type=\"radio\" name=\"file_name\" value=\"" + file_name + "\"><br><br>");
					}
				} else {
					alert("status: " + data.status);
				}
			}).fail(function(jqXhr, statuscode, errorMSG){
				alert("error: " + errorMSG);
			});
		}
	});
</script>